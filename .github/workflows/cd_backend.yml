on:
    push:
  jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        # Checkout the repository
        - name: Checking out the code
          uses: actions/checkout@v2
  
        # Login to Docker Hub
        - name: Docker login
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKERHUBUSERNAME }}
            password: ${{ secrets.DOCKERHUBTOKEN }}
  
        # Build and push Docker image to Docker Hub
        - name: Build and push to Docker Hub    
          uses: docker/build-push-action@v4
          with:
            context: .  # Set the context to the root of the repository
            file: ./docker/Dockerfile.backend  # Dockerfile located at ./docker/Dockerfile.backend
            push: true
            tags: alexgoot/backend:${{ github.sha }}
  
        # Deploy to the VM via SSH
        - name: Deploy to the VM
          run: |
            # Save the SSH private key from GitHub secrets to a file
            echo "${{ secrets.SSHKEY }}" > ~/ssh_key
  
            # Set correct file permissions for the SSH key
            chmod 600 ~/ssh_key
  
            # SSH to the VM and stop/remove the old container, then run the new container
            ssh -o StrictHostKeyChecking=no -i ~/ssh_key ubuntu@13.203.207.90 -t <<EOF
              # Stop and remove the existing container (if any)
              docker stop user_backend || true
              docker rm user_backend || true
  
              # Run the new container with the updated image
              docker run --name user_backend -d -p 3000:3000 alexgoot/backend:${{ github.sha }}
            EOF
  